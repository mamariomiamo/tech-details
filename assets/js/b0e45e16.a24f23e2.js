(self.webpackChunktech_details=self.webpackChunktech_details||[]).push([[2957],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return c},kt:function(){return u}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),m=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=m(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=m(n),u=i,f=p["".concat(l,".").concat(u)]||p[u]||d[u]||o;return n?a.createElement(f,r(r({ref:t},c),{},{components:n})):a.createElement(f,r({ref:t},c))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var m=2;m<o;m++)r[m]=n[m];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},36730:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return m},toc:function(){return c},default:function(){return p}});var a=n(22122),i=n(19756),o=(n(67294),n(3905)),r=["components"],s={hide_title:!0,sidebar_label:"System Level Tests"},l="Running Basalt VIO",m={unversionedId:"research/vio/basalt-tests",id:"research/vio/basalt-tests",isDocsHomePage:!1,title:"Running Basalt VIO",description:"Example to run on drone 23:",source:"@site/docs/research/vio/basalt-tests.md",sourceDirName:"research/vio",slug:"/research/vio/basalt-tests",permalink:"/tech-details/docs/research/vio/basalt-tests",version:"current",lastUpdatedAt:1626243292,formattedLastUpdatedAt:"7/14/2021",frontMatter:{hide_title:!0,sidebar_label:"System Level Tests"},sidebar:"researchSidebar",previous:{title:"Basalt Frontend (Optical Flow)",permalink:"/tech-details/docs/research/vio/basalt-frontend"},next:{title:"Framework Overview",permalink:"/tech-details/docs/research/edt/edt-overview"}},c=[{value:"Modes to Run In",id:"modes-to-run-in",children:[]},{value:"ROS to Mavros to PX4 (Odometry / vehicle_visual_odometry)",id:"ros-to-mavros-to-px4-odometry--vehicle_visual_odometry",children:[]},{value:"26 Oct 2020 Major Algorithmic Fixes",id:"26-oct-2020-major-algorithmic-fixes",children:[]},{value:"Major Improvement over Outdoor Stability",id:"major-improvement-over-outdoor-stability",children:[{value:"Fixed Crashing Issues",id:"fixed-crashing-issues",children:[]},{value:"Video Demos",id:"video-demos",children:[]}]},{value:"Major Improvement over Stability",id:"major-improvement-over-stability",children:[{value:"Some Video Demos",id:"some-video-demos",children:[]}]}],d={toc:c};function p(e){var t=e.components,s=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"running-basalt-vio"},"Running Basalt VIO"),(0,o.kt)("p",null,"Example to run on drone 23:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# terminal 1\nroscore\n\n# terminal 2 - mavros (time sync)\nroslaunch mavros px4.launch gcs_url:=udp://:14540@10.42.0.1/\n# need to wait for the time sync to finish in Mavros\n\n# terminal 3 - camera driver\nroslaunch tiscamera_ros tiscamera_ros_drone23.launch\n# tiscamera_ros should print sync success\n\n# terminal 4 - VIO instance\nroslaunch basalt tis_23.launch\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Running VIO",src:n(73037).Z})),(0,o.kt)("h2",{id:"modes-to-run-in"},"Modes to Run In"),(0,o.kt)("p",null,"Refer here for the full list of fusion modes:\n",(0,o.kt)("a",{parentName:"p",href:"https://docs.px4.io/master/en/advanced_config/tuning_the_ecl_ekf.html#ekf2_extvis"},"https://docs.px4.io/master/en/advanced_config/tuning_the_ecl_ekf.html#ekf2_extvis")),(0,o.kt)("p",null,"Modes to test and compare with:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"GPS + EV_VEL + ROTATE_EV (recommended)"),(0,o.kt)("li",{parentName:"ul"},"GPS + EV_POS + ROTATE_EV (not recommened?)"),(0,o.kt)("li",{parentName:"ul"},"EV_POS + EV_VEL + ROTATE_EV"),(0,o.kt)("li",{parentName:"ul"},"EV_POS + ROTATE_EV")),(0,o.kt)("h2",{id:"ros-to-mavros-to-px4-odometry--vehicle_visual_odometry"},"ROS to Mavros to PX4 (Odometry / vehicle_visual_odometry)"),(0,o.kt)("p",null,"The mavros received external vision (VIO) position estimate through either POSE or ODOMETRY messages, done through remapping."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},'\x3c!-- You should only remap either vision_pose or odometry, but not both --\x3e\n\n\x3c!-- /mavros/vision_pose/pose is posestamped, where /mavros/vision_pose/pose is posewithcovariancestamped --\x3e\n\x3c!-- <remap from="/mavros/vision_pose/pose" to="/basalt/pose_enu" /> --\x3e\n\n<remap from="/mavros/odometry/out" to="/basalt/odom_ned" />\n')),(0,o.kt)("p",null,"For more documentation please find at ",(0,o.kt)("a",{parentName:"p",href:"https://dev.px4.io/master/en/ros/external_position_estimation.html"},"https://dev.px4.io/master/en/ros/external_position_estimation.html")),(0,o.kt)("h1",{id:"system-level-tests"},"System Level Tests"),(0,o.kt)("h2",{id:"26-oct-2020-major-algorithmic-fixes"},"26 Oct 2020 Major Algorithmic Fixes"),(0,o.kt)("p",null,"Bug Fixes:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Fix bugs in LM optimisation steps, for convergence check and rollback step"),(0,o.kt)("li",{parentName:"ul"},"Fix a exception error in keyframe marginalisation logics (indexing non-existing frame / pose entries)")),(0,o.kt)("p",null,"Improvements:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Improve KF creation logics, add throttling to prevent keep creating KF under low feature environments")),(0,o.kt)("h2",{id:"major-improvement-over-outdoor-stability"},"Major Improvement over Outdoor Stability"),(0,o.kt)("p",null,"Sep 2020 Update:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"GPS interference by USB / Fan is huge"),(0,o.kt)("li",{parentName:"ul"},"Short of J120 boards")),(0,o.kt)("p",null,"Potential issues of the current system:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Initialisation may fail / jitter a lot, if the drone starts at a very open field with no close features ( < 10m ?)"),(0,o.kt)("li",{parentName:"ul"},"When GPS is used, VIO degraded to relative measurement. It may not correct GPS jumps effectively"),(0,o.kt)("li",{parentName:"ul"},"Possible to explore VIO as velocity measurement, built into ECL EKF onboard PX4")),(0,o.kt)("h3",{id:"fixed-crashing-issues"},"Fixed Crashing Issues"),(0,o.kt)("h4",{id:"frontend---boundary-check-using-actual-camera-model"},"Frontend - Boundary Check Using Actual Camera Model"),(0,o.kt)("p",null,"Instead of rectangular boundary check, use the actual fisheye lens boundary for optical flow tracking checks, as well as keypoint detection:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp",metastring:'title="Example"',title:'"Example"'},"if (!calib.intrinsics[0].inBound(transform.translation()))\n    patch_valid = false;\n")),(0,o.kt)("h4",{id:"backend---triangulation-checks-numerical"},"Backend - Triangulation Checks (Numerical)"),(0,o.kt)("p",null,"Ignore points behind the camera:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'if (p0_triangulated[2] < 0.0)\n{\n    if (config.vio_debug)\n        std::cout << "point " << p0_triangulated.transpose() <<" is behind the camera, throw away" << std::endl;\n    continue;\n}\n')),(0,o.kt)("h4",{id:"backend---keyframe-selection-criteria-optimisation-initialisation"},"Backend - Keyframe Selection Criteria Optimisation (Initialisation)"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'  // hm: check if keyframe is needed(\n  // hm: criteria 1: landmarks in the database is low (indexed by current key frames), and there are available unconnected ones\n  // hm: criteria 2: only a small ratio of landmarks are observed, time to marginalise old key frames!\n  if ( ( (lmdb.numLandmarks() < 12 && lmdb.numLandmarks() / opt_flow_meas->num_good_ids < 0.4  ) || double(connected0) / (lmdb.numLandmarks() + 1) < config.vio_new_kf_keypoints_thresh)\n        && (frames_after_kf > config.vio_min_frames_after_kf))\n    take_kf = true;\n\n\n  static bool initialise_baseline = false;\n  if (!initialise_baseline){\n    // latest state translation to the first pose position\n\n    try {\n      double moved_dist = (frame_states.at(last_state_t_ns).getState().T_w_i.translation()).norm();\n      if ( moved_dist > config.vio_min_triangulation_dist * 1.1 && frames_after_kf > config.vio_min_frames_after_kf){\n        take_kf = true; // take a keyframe when the time is right after start;\n        initialise_baseline = true;\n      }\n    }catch (const std::out_of_range& e) {\n        std::cout << "Out of Range error at initialise_baseline" << std::endl;\n    }\n    \n\n  }\n')),(0,o.kt)("h4",{id:"frontend---good-features-to-use"},"Frontend - Good Features To Use"),(0,o.kt)("p",null,"Define good observation points, as the points tracked at least in one consecutive pair of frames. And only those observations are used for back-end"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"{\nint good_ids = 0;\nfor (auto& obs : transforms->observations){\n    for (auto& kv : obs){\n    // unsigned\n    if (kv.first < pre_last_keypoint_id)\n        good_ids++;\n    }\n}\n\ntransforms->num_good_ids = good_ids;\n}\n")),(0,o.kt)("h4",{id:"backend---marginalise-far-frames"},"Backend - Marginalise Far Frames"),(0,o.kt)("p",null,"Detect distance between any keyframes and the latest keyframes"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'if (id_to_marg < 0) { \n\n    int64_t last_kf = *kf_ids.crbegin(); // the last keyframe always has a state\n\n    for (int64_t id : kf_ids) {\n        auto dist = (frame_poses.at(id).getPose().translation() - frame_states.at(last_kf).getState().T_w_i.translation()).norm();\n\n        if (dist > 10){\n        id_to_marg = id;\n        std::cout << "keyframe too far (> 10 m) removing" << std::endl;\n        }\n\n    }\n\n}\n')),(0,o.kt)("h4",{id:"detect-speed--15ms-and-crash-automatically"},"Detect Speed > 15m/s, and crash automatically"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'      if (last_t_ns > 0){\n        auto delta_t = t_ns - last_t_ns;\n        auto delta_t_w_i = T_w_i.translation() - vio_t_w_i.back();\n\n        // hm: greater than 15 m/s\n        if (delta_t_w_i.norm() / delta_t > 15 )\n        {\n          std::cout << "detect speed to fast > 15 m/s" << std::endl;\n          abort();\n        }\n      }else{\n        first_t_ns = t_ns;\n      }\n      last_t_ns = t_ns;\n')),(0,o.kt)("h3",{id:"video-demos"},"Video Demos"),(0,o.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/sjBY2vqDDo8",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),(0,o.kt)("h2",{id:"major-improvement-over-stability"},"Major Improvement over Stability"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Work Done:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Redesign the mounting plate (credit Yanfeng)"),(0,o.kt)("li",{parentName:"ul"},"Recalibrated the Pixhawk (credit Yanfeng)"),(0,o.kt)("li",{parentName:"ul"},"Recalibrating the prototype rig, by covering all corners of the image",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Calibration verified by Kalibr's validator, and Jalvin's triangulation code"))),(0,o.kt)("li",{parentName:"ul"},"Increase the IMU rates from 100Hz to 200 Hz, to make the pre-integration more stable (20ms is too long an interval)",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Use ",(0,o.kt)("inlineCode",{parentName:"li"},"HIGHRES_IMU")," aka ",(0,o.kt)("inlineCode",{parentName:"li"},"/mavros/imu/data_raw")," topic"),(0,o.kt)("li",{parentName:"ul"},"It has certain filtering delay, but should be negligible (few ms?)"))),(0,o.kt)("li",{parentName:"ul"},"Discovered incorrect time sync matches between camera-imu. Fixed it (50ms delay on laptop)",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Do not confuse the mean delay between camera and imu, and the OS delay (a measure between kernel v4l2 image reception and ros image reception). The mean delay on laptop is normally smaller than 80ms."),(0,o.kt)("li",{parentName:"ul"},"Observe the visualisation on basalt, when there is large rotation motion. If the camera is out of sync, the optimisation will shift the observing point by a lot. THIS INDICATES THE ERROR."))),(0,o.kt)("li",{parentName:"ul"},"Fixed various crashing bugs",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"shrinking the viewing angle to < 165 degree, by adding ",(0,o.kt)("inlineCode",{parentName:"li"},"alpha_offset")),(0,o.kt)("li",{parentName:"ul"},"fixed std::map error which occured in visualising the keypoints' original observation locations"),(0,o.kt)("li",{parentName:"ul"},"fixed a divide by zero bug in front-end")))),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This framework rely highly upon ",(0,o.kt)("strong",{parentName:"p"},"calibration")," and correct ",(0,o.kt)("strong",{parentName:"p"},"hardware synchronisation"),". All sensor measurement timings should be precise at few-milliseconds level."))),(0,o.kt)("h3",{id:"some-video-demos"},"Some Video Demos"),(0,o.kt)("h4",{id:"indoor"},"Indoor"),(0,o.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/3ISeNw7O7JQ",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),(0,o.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/H4uas0846cs",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),(0,o.kt)("h4",{id:"outdoor"},"Outdoor"),(0,o.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/1LemsSnps4w",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"TODO:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The config ",(0,o.kt)("inlineCode",{parentName:"li"},"vio_filter_iteration")," effectiveness is still to be determined"),(0,o.kt)("li",{parentName:"ul"},"Performance of GN and LM optimisation method test"),(0,o.kt)("li",{parentName:"ul"},"Test ",(0,o.kt)("inlineCode",{parentName:"li"},"vio_enforce_realtime")," option"),(0,o.kt)("li",{parentName:"ul"},"Port over to TX2 to verify the performance again, try to hit >10Hz update rate.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Full Config File")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="tis_config.json"',title:'"tis_config.json"'},'{\n    "value0": {\n        "config.optical_flow_type": "frame_to_frame",\n        "config.optical_flow_detection_grid_size": 60,\n        "config.optical_flow_max_recovered_dist2": 5.0,\n        "config.optical_flow_pattern": 51,\n        "config.optical_flow_max_iterations": 5,\n        "config.optical_flow_epipolar_error": 0.05,\n        "config.optical_flow_levels": 4,\n        "config.optical_flow_skip_frames": 1,\n        "config.feature_match_show": false,\n        "config.vio_max_states": 3,\n        "config.vio_max_kfs": 7,\n        "config.vio_min_frames_after_kf": 3,\n        "config.vio_new_kf_keypoints_thresh": 0.6,\n        "config.vio_debug": false,\n        "config.vio_obs_std_dev": 0.5,\n        "config.vio_obs_huber_thresh": 1.0,\n        "config.vio_min_triangulation_dist": 0.15,\n        "config.vio_outlier_threshold": 10,\n        "config.vio_filter_iteration": 4,\n        "config.vio_max_iterations": 7,\n        "config.vio_enforce_realtime": false,\n        "config.vio_use_lm": true,\n        "config.vio_lm_lambda_min": 1e-32,\n        "config.vio_lm_lambda_max": 1e2,\n        "config.vio_init_pose_weight": 1e12,\n        "config.vio_init_ba_weight": 1e1,\n        "config.vio_init_bg_weight": 1e2,\n\n        "config.mapper_obs_std_dev": 0.25,\n        "config.mapper_obs_huber_thresh": 1.5,\n        "config.mapper_detection_num_points": 800,\n        "config.mapper_num_frames_to_match": 30,\n        "config.mapper_frames_to_match_threshold": 0.04,\n        "config.mapper_min_matches": 20,\n        "config.mapper_ransac_threshold": 5e-5,\n        "config.mapper_min_track_length": 5,\n        "config.mapper_max_hamming_distance": 70,\n        "config.mapper_second_best_test_ratio": 1.2,\n        "config.mapper_bow_num_bits": 16,\n        "config.mapper_min_triangulation_dist": 0.07,\n        "config.mapper_no_factor_weights": false,\n        "config.mapper_use_factors": true,\n        "config.mapper_use_lm": true,\n        "config.mapper_lm_lambda_min": 1e-32,\n        "config.mapper_lm_lambda_max": 1e3\n    }\n}\n\n')))}p.isMDXComponent=!0},73037:function(e,t,n){"use strict";t.Z=n.p+"assets/images/basalt_vio_running-3846a31352323bf75c164c20befb5e04.png"}}]);